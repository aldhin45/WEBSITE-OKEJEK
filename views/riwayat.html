<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Riwayat | Oke-Jek</title>
  <link rel="stylesheet" href="/css/riwayat.css">
</head>
<body>
  <header class="navbar">
    <div class="container">
      <h1 class="logo">Oke-Jek</h1>
      <nav class="nav-links">
        <a href="/home">Beranda</a>
        <a href="/pesan">Pesan</a>
        <a href="/riwayat" class="active">Riwayat</a>
        <a href="/profil">Profil</a>
        <a href="/keluar" class="logout">Keluar</a>
      </nav>
    </div>
  </header>

  <main class="content">
    <h2>Riwayat Perjalanan</h2>
    
    <div class="history-list" id="historyContainer">
      <p style="text-align:center; color: #888;">Memuat riwayat...</p>
    </div>
  </main>

  <footer class="footer">
    <p>© <span id="year"></span> Oke-Jek</p>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // --- FUNGSI SANITIZER / PEMBERSIH ---
    // Fungsi ini mengubah karakter berbahaya menjadi kode aman HTML
    function escapeHTML(str) {
        if (!str) return ""; // Jika data kosong, kembalikan string kosong
        
        // Ubah string menjadi string aman
        return String(str).replace(/[&<>"']/g, function(match) {
            const escape = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            };
            return escape[match];
        });
    }

    // --- FUNGSI FORMAT LAINNYA ---
    function formatTanggal(tanggalString) {
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return new Date(tanggalString).toLocaleDateString('id-ID', options);
    }

    function formatRupiah(angka) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(angka);
    }

    function formatLayanan(jenis) {
        if (jenis === 'motor') return 'Ojek Motor';
        if (jenis === 'mobil') return 'Ojek Mobil';
        if (jenis === 'barang') return 'Kirim Barang';
        return escapeHTML(jenis); // Bersihkan inputan default juga
    }

    // --- LOGIKA UTAMA ---
    async function loadRiwayat() {
        try {
            const response = await fetch('/api/riwayat');
            const result = await response.json();
            const container = document.getElementById('historyContainer');
            container.innerHTML = '';

            if (result.success && result.data.length > 0) {
                result.data.forEach(item => {
                    const card = document.createElement('div');
                    card.classList.add('card');
                    
                    const driverName = item.nama_driver ? item.nama_driver : "Sedang dicari...";
                    const vehicleInfo = item.info_kendaraan ? item.info_kendaraan : "";

                    // menambahkan escapeHTML(...) di variabel user
                    card.innerHTML = `
                        <button class="btn-delete" onclick="hapusPesanan(${item.id})">Hapus</button>
                        
                        <h3>${escapeHTML(item.lokasi_jemput)} ➜ ${escapeHTML(item.tujuan)}</h3>
                        
                        <p>
                            <strong>${formatLayanan(item.jenis_layanan)}</strong> • 
                            ${formatRupiah(item.harga)} • 
                            ${formatTanggal(item.tanggal)}
                        </p>
                        
                        <div class="driver-info">
                            Driver: <strong>${escapeHTML(driverName)}</strong><br>
                            <span style="font-size: 0.85rem; color: #888;">${escapeHTML(vehicleInfo)}</span>
                        </div>

                        <span class="status-badge">${escapeHTML(item.status)}</span>
                    `;
                    container.appendChild(card);
                });
            } else {
                container.innerHTML = '<p style="text-align:center;">Belum ada riwayat perjalanan.</p>';
            }

        } catch (error) {
            console.error("Error:", error);
            document.getElementById('historyContainer').innerHTML = '<p style="text-align:center; color:red;">Gagal memuat data.</p>';
        }
    }

    async function hapusPesanan(id) {
        if (!confirm("Apakah Anda yakin ingin menghapus riwayat ini?")) {
            return;
        }
        try {
            const response = await fetch(`/api/riwayat/${id}`, { method: 'DELETE' });
            const result = await response.json();

            if (result.success) {
                alert("Riwayat berhasil dihapus!");
                loadRiwayat(); 
            } else {
                alert("Gagal: " + result.message);
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Gagal menghubungi server.");
        }
    }

    loadRiwayat();
  </script>
</body>
</html>