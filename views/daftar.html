<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Panel | Oke-Jek</title>
    <link rel="stylesheet" href="/css/driver.css">
</head>
<body>

    <div class="sidebar">
        <h1>Mitra Driver</h1>
        <a onclick="showSection('dashboard')" class="menu-item active" id="btn-dashboard">Pekerjaan</a>
        <a onclick="showSection('riwayat')" class="menu-item" id="btn-riwayat">Riwayat Order</a>
        <a onclick="showSection('profil')" class="menu-item" id="btn-profil">Profil Kendaraan</a>
        <a href="/keluar" class="menu-item menu-logout">Keluar</a>
    </div>

    <div class="content">
        
        <div id="dashboard" class="section active">
            <h2>Status Hari Ini</h2>
            <div class="card-grid">
                <div class="stat-card">
                    <h3>Pendapatan</h3>
                    <p id="totalPendapatan" style="color: #28a745;">Rp 0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Order Selesai</h3>
                    <p id="totalOrder">0</p>
                </div>
                <div class="stat-card">
                    <h3>Rating</h3>
                    <p>‚≠ê 5.0</p>
                </div>
            </div>

            <h2>Pekerjaan Aktif</h2>
            <div id="activeJobContainer">
                <div style="text-align:center; padding: 40px; background:white; border-radius:12px; color:#888;">
                    <p>Belum ada pesanan masuk. Standby ya!</p>
                </div>
            </div>
        </div>

        <div id="riwayat" class="section">
            <h2>Riwayat Penyelesaian</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Rute</th>
                            <th>Layanan</th>
                            <th>Harga</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableRiwayat">
                        <tr><td colspan="5">Memuat...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="profil" class="section">
            <h2>Profil Mitra</h2>
            <div class="stat-card" style="max-width: 500px;">
                <h3 style="margin-bottom:20px;">Informasi Akun</h3>
                <p style="font-size:1rem; margin:5px 0;">Nama: <strong id="profNama">-</strong></p>
                <p style="font-size:1rem; margin:5px 0;">Email: <strong id="profEmail">-</strong></p>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                <h3 style="margin-top:20px;">Informasi Kendaraan</h3>
                <p style="font-size:1rem; margin:5px 0;">Kendaraan: <strong id="profMerk">-</strong></p>
                <p style="font-size:1rem; margin:5px 0;">Plat Nomor: <strong id="profPlat">-</strong></p>
                <p style="font-size:1rem; margin:5px 0;">Status: <span class="badge">ONLINE</span></p>
            </div>
        </div>

    </div>

    <script>
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.getElementById('btn-' + sectionId).classList.add('active');
        }

        const formatRupiah = (num) => 'Rp ' + num.toLocaleString('id-ID');

        async function loadDriverData() {
            try {
                const response = await fetch('/api/driver/data');
                const data = await response.json();

                if(data.success) {
                    document.getElementById('totalPendapatan').textContent = formatRupiah(data.pendapatan);
                    document.getElementById('totalOrder').textContent = data.riwayat.length;

                    document.getElementById('profNama').textContent = data.profil.nama;
                    document.getElementById('profEmail').textContent = data.profil.email;
                    document.getElementById('profMerk').textContent = data.profil.merk_kendaraan || '-';
                    document.getElementById('profPlat').textContent = data.profil.nomor_polisi || '-';

                    const jobContainer = document.getElementById('activeJobContainer');
                    if (data.pesananAktif.length > 0) {
                        const job = data.pesananAktif[0];
                        jobContainer.innerHTML = `
                            <div class="job-card">
                                <h2>üîî Orderan Masuk!</h2>
                                <p>Layanan: <strong>${job.jenis_layanan}</strong></p>
                                <div class="job-route">
                                    ${job.lokasi_jemput} ‚ûù ${job.tujuan}
                                </div>
                                <p style="font-size: 1.5rem; color: #ffcc00;">${formatRupiah(job.harga)}</p>
                                <button class="btn-finish" onclick="selesaikanPesanan(${job.id})">‚úÖ Selesaikan Pesanan</button>
                            </div>
                        `;
                    } else {
                        jobContainer.innerHTML = `
                            <div style="text-align:center; padding: 40px; background:white; border-radius:12px; color:#888;">
                                <h3>Tidak ada pesanan aktif</h3>
                                <p>Menunggu pesanan masuk...</p>
                            </div>`;
                    }

                    const tbody = document.getElementById('tableRiwayat');
                    tbody.innerHTML = '';
                    data.riwayat.forEach(p => {
                        tbody.innerHTML += `
                            <tr>
                                <td>#${p.id}</td>
                                <td>${p.lokasi_jemput} ‚ûù ${p.tujuan}</td>
                                <td>${p.jenis_layanan}</td>
                                <td>${formatRupiah(p.harga)}</td>
                                <td><span class="badge">Selesai</span></td>
                            </tr>`;
                    });
                }
            } catch (err) { console.error(err); }
        }

        async function selesaikanPesanan(id) {
            if(!confirm("Sudah mengantar penumpang sampai tujuan?")) return;

            const response = await fetch('/api/driver/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pesanan_id: id })
            });
            
            const result = await response.json();
            if(result.success) {
                alert("Pekerjaan Selesai! Saldo bertambah.");
                loadDriverData();
            } else {
                alert("Gagal update status.");
            }
        }

        loadDriverData();
        setInterval(loadDriverData, 10000);
    </script>
</body>
</html>